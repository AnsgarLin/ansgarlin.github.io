<!DOCTYPE html>
<html lang="zh-tw">
<head prefix="og: http://ogp.me/ns#">
  <meta charset="utf-8">
  <title>Why The Shape Works Unexpectedly In The layer-list Before Android-22? | Ansgar</title>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Canonical links -->
  <link rel="canonical" href="https://ansgarlin.github.io/zh-tw/news/2018/03/09/why_the_shape_works_unexpectedly_in_the_layer_list_before_android_22/index.html">
  <!-- Alternative links -->
  
  <!-- Icon -->
  <link rel="apple-touch-icon" sizes="57x57" href="/icon/apple-touch-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/icon/apple-touch-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/icon/apple-touch-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/icon/apple-touch-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/icon/apple-touch-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/icon/apple-touch-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/icon/apple-touch-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icon/apple-touch-icon-152x152.png">
  <link rel="icon" type="image/png" href="/icon/favicon-196x196.png" sizes="196x196">
  <link rel="icon" type="image/png" href="/icon/favicon-160x160.png" sizes="160x160">
  <link rel="icon" type="image/png" href="/icon/favicon-96x96.png" sizes="96x96">
  <link rel="icon" type="image/png" href="/icon/favicon-16x16.png" sizes="16x16">
  <link rel="icon" type="image/png" href="/icon/favicon-32x32.png" sizes="32x32">
  <meta name="msapplication-TileColor" content="#2f83cd">
  <meta name="msapplication-TileImage" content="/icon/mstile-144x144.png">
  <meta name="generator" content="Hexo 5.2.0">
  <!-- CSS -->
  <!-- build:css build/css/navy.css -->
  
<link rel="stylesheet" href="/css/navy.css">

  <!-- endbuild -->
  <link href="https://fonts.googleapis.com/css?family=Lato:300,400,700" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css">
  <!-- RSS -->
  <link rel="alternate" href="/atom.xml" title="Ansgar" type="application/atom+xml">
  <!-- Open Graph -->
  <meta name="description" content="近期在設計畫面時遇到一個特殊的問題：  使用&lt;layer-list&gt;當背景，在android版本為22之前的機器上執行會與預期的不同。  在這直接以我們使用的實作作為範例：第一層是白色背景，搭配左上和右上的圓角。第二層則是貼齊第一層底部，高度為1dp的灰色線條： &lt;layer-list xmlns:android&#x3D;&quot;http:&#x2F;&#x2F;schemas.android.com&#x2F;">
<meta property="og:type" content="article">
<meta property="og:title" content="Why The Shape Works Unexpectedly In The layer-list Before Android-22?">
<meta property="og:url" content="https://ansgarlin.github.io/zh-tw/news/2018/03/09/why_the_shape_works_unexpectedly_in_the_layer_list_before_android_22/index.html">
<meta property="og:site_name" content="Ansgar">
<meta property="og:description" content="近期在設計畫面時遇到一個特殊的問題：  使用&lt;layer-list&gt;當背景，在android版本為22之前的機器上執行會與預期的不同。  在這直接以我們使用的實作作為範例：第一層是白色背景，搭配左上和右上的圓角。第二層則是貼齊第一層底部，高度為1dp的灰色線條： &lt;layer-list xmlns:android&#x3D;&quot;http:&#x2F;&#x2F;schemas.android.com&#x2F;">
<meta property="og:locale" content="zh_TW">
<meta property="og:image" content="https://ansgarlin.github.io/zh-tw/news/2018/03/09/why_the_shape_works_unexpectedly_in_the_layer_list_before_android_22/layer_list_android_23.png">
<meta property="og:image" content="https://ansgarlin.github.io/zh-tw/news/2018/03/09/why_the_shape_works_unexpectedly_in_the_layer_list_before_android_22/layer_list_android_22.png">
<meta property="article:published_time" content="2018-03-09T00:00:00.000Z">
<meta property="article:modified_time" content="2020-11-07T10:14:05.102Z">
<meta property="article:author" content="Ansgar Lin">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://ansgarlin.github.io/zh-tw/news/2018/03/09/why_the_shape_works_unexpectedly_in_the_layer_list_before_android_22/layer_list_android_23.png">
  <!-- Google Analytics -->
  
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-6482217598104186",
          enable_page_level_ads: true
     });
  </script>
</head>

<body>
  <div id="container">
    <header id="header" class="wrapper">
  <div id="header-inner" class="inner">
    <a href="/zh-tw/" class="main-nav-link"><i class="fa fa-home"></i></a>
    <nav id="main-nav">
      <a href="/news/" class="main-nav-link">文章</a><a href="/zh-tw/android/" class="main-nav-link">Android</a><a href="/zh-tw/kotlin/" class="main-nav-link">Kotlin</a><a href="/zh-tw/rxjava/" class="main-nav-link">RxJava</a>
      <a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/AnsgarLin" class="main-nav-link"><i class="fa fa-github-alt"></i></a>
    </nav>
    <div id="lang-select-wrap">
      <label id="lang-select-label"><i class="fa fa-globe"></i><span>正體中文</span></label>
      <select id="lang-select" data-canonical="">
        
          <option value="en">English</option>
        
          <option value="zh-tw" selected>正體中文</option>
        
      </select>
    </div>
    <a id="mobile-nav-toggle">
      <span class="mobile-nav-toggle-bar"></span>
      <span class="mobile-nav-toggle-bar"></span>
      <span class="mobile-nav-toggle-bar"></span>
    </a>
  </div>
</header>

    <div id="content-wrap">
  <div class="wrapper">
    <div class="inner">
      <article class="article post" itemscope itemtype="http://schema.org/Article">
  <header class="article-header">
    
      <h1 class="article-title" itemprop="name">Why The Shape Works Unexpectedly In The layer-list Before Android-22?</h1>
    
    <a href="/zh-tw/news/2018/03/09/why_the_shape_works_unexpectedly_in_the_layer_list_before_android_22/" class="article-date"><time datetime="2018-03-09T00:00:00.000Z">2018-03-09</time></a>
  </header>
  <div class="article-content" itemprop="articleBody">
    <p>近期在設計畫面時遇到一個特殊的問題：</p>
<ul>
<li><strong>使用<code>&lt;layer-list&gt;</code>當背景，在android版本為22之前的機器上執行會與預期的不同</strong>。</li>
</ul>
<p>在這直接以我們使用的實作作為範例：第一層是白色背景，搭配左上和右上的圓角。第二層則是貼齊第一層底部，高度為1dp的灰色線條：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">layer-list</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">shape</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">solid</span> <span class="attr">android:color</span>=<span class="string">&quot;@color/bgWhite&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">corners</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:topLeftRadius</span>=<span class="string">&quot;6dp&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:topRightRadius</span>=<span class="string">&quot;6dp&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">shape</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">android:gravity</span>=<span class="string">&quot;bottom&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">shape</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">solid</span> <span class="attr">android:color</span>=<span class="string">&quot;@color/bgGray&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">size</span> <span class="attr">android:height</span>=<span class="string">&quot;1dp&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">shape</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">layer-list</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>第一層是白色背景，搭配左上和右上的圓角。第二層則是貼齊第一層底部，高度為1dp的灰色線條。23之後的版本會如預期的呈現：</p>
<p><img src="layer_list_android_23.png" alt="layer_list_android_23"></p>
<p>但在22以下則會如下：</p>
<p><img src="layer_list_android_22.png" alt="layer_list_android_22"></p>
<p>經過測試後發現這個覆蓋在背景上的灰色，是原本應該是至於底部的線條，變成擴張到整個View的範圍。判斷是版本不同產生的差異，應是版本間的程式碼有些不同。</p>
<h3 id="定義差異範圍" class="article-heading"><a href="#定義差異範圍" class="headerlink" title="定義差異範圍"></a>定義差異範圍<a class="article-anchor" href="#定義差異範圍" aria-hidden="true"></a></h3><p>因為範例很單純，我們可以輕易的將分析範圍限縮在以下兩個Drawable衍生類別：</p>
<ul>
<li>ShapeDrawable</li>
<li>LayerDrawable</li>
</ul>
<p>和代表不同Shape的類別，不過在這設計中沒有特別指定，因此可以再縮小至以下幾種Shape類別：</p>
<ul>
<li>RectShape</li>
<li>RoundRectShape</li>
<li>Shape</li>
</ul>
<h3 id="分析差異" class="article-heading"><a href="#分析差異" class="headerlink" title="分析差異"></a>分析差異<a class="article-anchor" href="#分析差異" aria-hidden="true"></a></h3><p>要找出差異，有分兩個層次：</p>
<ul>
<li>檔案異同。</li>
<li>相異的片段是否會造成行為不同，或只是一些錯誤處理。</li>
</ul>
<p>以下我們從檔案比較小的Shape類別開始做比對。</p>
<blockquote>
<p>以下所有進行對照的原始碼皆來自<a target="_blank" rel="noopener external nofollow noreferrer" href="http://androidxref.com/">http://androidxref.com/</a></p>
</blockquote>
<h4 id="RectShape-RoundRectShape-Shape" class="article-heading"><a href="#RectShape-RoundRectShape-Shape" class="headerlink" title="RectShape, RoundRectShape, Shape"></a>RectShape, RoundRectShape, Shape<a class="article-anchor" href="#RectShape-RoundRectShape-Shape" aria-hidden="true"></a></h4><p>每個檔案行數都不多，直接對照行數的結果是沒有任何變動。於是可以快速地進入Drawable衍生類。</p>
<h4 id="ShapeDrawable" class="article-heading"><a href="#ShapeDrawable" class="headerlink" title="ShapeDrawable"></a>ShapeDrawable<a class="article-anchor" href="#ShapeDrawable" aria-hidden="true"></a></h4><p>檔案有些許更動，但只是單純的更改命名方式和函式宣告，並不會影響原始行為。</p>
<h4 id="LayerDrawable" class="article-heading"><a href="#LayerDrawable" class="headerlink" title="LayerDrawable"></a>LayerDrawable<a class="article-anchor" href="#LayerDrawable" aria-hidden="true"></a></h4><p>檔案變動很多，大部分是新增了對外的函示，讓LayerDrawable可從外部進行設定。少部分和ShapeDrawable類似，並不影響原始行為。</p>
<p>由於我們此次是要知道繪圖範圍會產生變化的原因，所以餘下的部分透過字串搜尋height後，發現新版本的開頭註解有些不同。</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">* @attr ref android.R.styleable#LayerDrawable_paddingMode</span><br><span class="line">* @attr ref android.R.styleable#LayerDrawableItem_left</span><br><span class="line">* @attr ref android.R.styleable#LayerDrawableItem_top</span><br><span class="line">* @attr ref android.R.styleable#LayerDrawableItem_right</span><br><span class="line">* @attr ref android.R.styleable#LayerDrawableItem_bottom</span><br><span class="line"><span class="comment">// Android 23後新增內容</span></span><br><span class="line">* @attr ref android.R.styleable#LayerDrawableItem_start</span><br><span class="line">* @attr ref android.R.styleable#LayerDrawableItem_end</span><br><span class="line">* @attr ref android.R.styleable#LayerDrawableItem_width</span><br><span class="line">* @attr ref android.R.styleable#LayerDrawableItem_height</span><br><span class="line">* @attr ref android.R.styleable#LayerDrawableItem_gravity</span><br><span class="line"><span class="comment">// -------------------- //</span></span><br><span class="line">* @attr ref android.R.styleable#LayerDrawableItem_drawable</span><br><span class="line">* @attr ref android.R.styleable#LayerDrawableItem_id</span><br></pre></td></tr></table></figure>

<p>於是我們得到了解答：</p>
<ul>
<li><strong>之前版本都沒有的參數，自然設定了也無法判別。</strong></li>
</ul>
<h3 id="What’s-more" class="article-heading"><a href="#What’s-more" class="headerlink" title="What’s more"></a>What’s more<a class="article-anchor" href="#What’s-more" aria-hidden="true"></a></h3><p>既然我們理解為什麼給予的設定無效後，那也要理解新的參數如何影響最後呈現的畫面。並聚焦在我們有使用到的參數上。</p>
<p>以下我們繼續使用相同範例。在新版的<code>onBoundChange()</code>中新增了一些計算在<code>setBounds()</code>之前：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// In LayerDrawable</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onBoundsChange</span><span class="params">(Rect bounds)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> nest = mLayerState.mPaddingMode == PADDING_MODE_NEST;</span><br><span class="line">    <span class="keyword">final</span> ChildDrawable[] array = mLayerState.mChildren;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> N = mLayerState.mNum;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">        <span class="keyword">final</span> ChildDrawable r = array[i];</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// 以下這部分</span></span><br><span class="line">        r.mDrawable.setBounds(bounds.left + r.mInsetL + padL, bounds.top + r.mInsetT + padT, bounds.right - r.mInsetR - padR, bounds.bottom - r.mInsetB - padB);</span><br><span class="line">------------------------------------------------------------------------------------------</span><br><span class="line">    	<span class="comment">// 換成以下這部分</span></span><br><span class="line">	    <span class="keyword">final</span> Drawable d = r.mDrawable;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">final</span> Rect container = mTmpContainer;</span><br><span class="line">        container.set(d.getBounds());</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// 這邊是一些為了與舊版本相容的調整</span></span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> w = r.mWidth &lt; <span class="number">0</span> ? d.getIntrinsicWidth() : r.mWidth;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> h = r.mHeight &lt; <span class="number">0</span> ? d.getIntrinsicHeight() : r.mHeight;</span><br><span class="line">        Gravity.apply(gravity, w, h, container, outRect, layoutDirection);</span><br><span class="line">        d.setBounds(outRect);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先不細看這些額外的操作，直接先看到<code>setBounds()</code>的用途：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// In Drawable</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Specify a bounding rectangle for the Drawable. This is where the drawable</span></span><br><span class="line"><span class="comment"> * will draw when its draw() method is called.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBounds</span><span class="params">(<span class="keyword">int</span> left, <span class="keyword">int</span> top, <span class="keyword">int</span> right, <span class="keyword">int</span> bottom)</span> </span>&#123; &#125;</span><br></pre></td></tr></table></figure>

<p>根據註解，此函式用於決定繪製範圍，因此我們可以確定前後版本顯示上的差異，一定是因爲前面提到的新增的操作，做了一些額外的調整。</p>
<h3 id="流程分析" class="article-heading"><a href="#流程分析" class="headerlink" title="流程分析"></a>流程分析<a class="article-anchor" href="#流程分析" aria-hidden="true"></a></h3><p>再進一步理解之前，先回頭了解LayerDrawable的兩個基本概念：</p>
<ul>
<li>初始化</li>
<li>繪製</li>
</ul>
<h4 id="初始化" class="article-heading"><a href="#初始化" class="headerlink" title="初始化"></a>初始化<a class="article-anchor" href="#初始化" aria-hidden="true"></a></h4><p>Drawable的初始化，首先先看到<code>inflate()</code>：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// In LayerDrawable</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">inflate</span><span class="params">(Resources r, XmlPullParser parser, AttributeSet attrs, Theme theme)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">final</span> TypedArray a = obtainAttributes(r, theme, attrs, R.styleable.LayerDrawable);</span><br><span class="line">    updateStateFromTypedArray(a);</span><br><span class="line">    a.recycle();</span><br><span class="line">  </span><br><span class="line">    inflateLayers(r, parser, attrs, theme);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>updateStateFromTypedArray()</code>內容是用於設定padding值，不過當前的範例並沒有針對<code>&lt;layer-list&gt;</code>的設定，於是直接跳過看到<code>inflateLayers()</code>：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// In LayerDrawable</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">inflateLayers</span><span class="params">(<span class="meta">@NonNull</span> Resources r, <span class="meta">@NonNull</span> XmlPullParser parser,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="meta">@NonNull</span> AttributeSet attrs, <span class="meta">@Nullable</span> Theme theme)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> LayerState state = mLayerState;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">                &amp;&amp; ((depth = parser.getDepth()) &gt;= innerDepth || type != XmlPullParser.END_TAG)) &#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">if</span> (depth &gt; innerDepth || !parser.getName().equals(<span class="string">&quot;item&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;  </span><br><span class="line">              </span><br><span class="line">            <span class="keyword">final</span> ChildDrawable layer = <span class="keyword">new</span> ChildDrawable(state.mDensity);</span><br><span class="line">            <span class="keyword">final</span> TypedArray a = obtainAttributes(r, theme, attrs, R.styleable.LayerDrawableItem);</span><br><span class="line">            updateLayerFromTypedArray(layer, a);</span><br><span class="line">            a.recycle();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If the layer doesn&#x27;t have a drawable or unresolved theme</span></span><br><span class="line">            <span class="comment">// attribute for a drawable, attempt to parse one from the child</span></span><br><span class="line">            <span class="comment">// element. If multiple child elements exist, we&#x27;ll only use the</span></span><br><span class="line">            <span class="comment">// first one.</span></span><br><span class="line">            <span class="keyword">if</span> (layer.mDrawable == <span class="keyword">null</span> &amp;&amp; (layer.mThemeAttrs == <span class="keyword">null</span> ||</span><br><span class="line">                    layer.mThemeAttrs[R.styleable.LayerDrawableItem_drawable] == <span class="number">0</span>)) &#123;</span><br><span class="line">                ...</span><br><span class="line">                <span class="comment">// We found a child drawable. Take ownership.</span></span><br><span class="line">                layer.mDrawable = Drawable.createFromXmlInner(r, parser, attrs, theme);</span><br><span class="line">                ...</span><br><span class="line">            &#125;</span><br><span class="line">            addLayer(layer);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>inflateLayers()</code>內主要執行兩件事：</p>
<ul>
<li>針對每一個<code>&lt;item&gt;</code>建立一個ChildDrawable，並透過<code>updateLayerFromTypedArray()</code>將存入設定在<code>&lt;item&gt;</code>上的屬性。</li>
<li>接著透過<code>createFromXmlInner</code>，將<code>&lt;item&gt;</code>包住的內容轉成特定的Drawable，然後再存入ChildDrawable中。</li>
<li>透過<code>addLayer()</code>將ChildDrawable存入<code>mLayerState</code>：</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// In LayerDrawable </span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">addLayer</span><span class="params">(ChildDrawable layer)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> LayerState st = mLayerState;</span><br><span class="line">    ...</span><br><span class="line">    st.mChildren[i] = layer;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>在所有LayerDrawable操作中，mLayerState都將持續用來每一層Drawable資料。</p>
</blockquote>
<p>結合當前範例，我們可以得知第二層的ChildDrawable，就是用來呈現灰色線條。結合ChildDrawable預設的參數，我們目前得到的ChildDrawable可以簡單表示如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ChildDrawable &#123;</span><br><span class="line">    width = -<span class="number">1</span>, height = -<span class="number">1</span>, </span><br><span class="line">    drawable = ShapeDrawable &#123;</span><br><span class="line">        height = <span class="number">1</span>, color = gray</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="繪製" class="article-heading"><a href="#繪製" class="headerlink" title="繪製"></a>繪製<a class="article-anchor" href="#繪製" aria-hidden="true"></a></h4><p>View的狀態改變時會呼叫到Drawable的<code>onStateChange()</code>，也就是LayerDrawable的<code>onStateChange()</code>：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// In LayerDrawable</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">onStateChange</span><span class="params">(<span class="keyword">int</span>[] state)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    updateLayerBounds(getBounds());</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再次的又回到先前介紹的<code>updateLayerBounds()</code>，為了方便閱讀，再次列出內容如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// In LayerDrawable</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onBoundsChange</span><span class="params">(Rect bounds)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> nest = mLayerState.mPaddingMode == PADDING_MODE_NEST;</span><br><span class="line">    <span class="keyword">final</span> ChildDrawable[] array = mLayerState.mChildren;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> N = mLayerState.mNum;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">        <span class="keyword">final</span> ChildDrawable r = array[i];</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">final</span> Drawable d = r.mDrawable;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">final</span> Rect container = mTmpContainer;</span><br><span class="line">        container.set(d.getBounds());</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// 這邊是一些為了與舊版本相容的調整</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> gravity = resolveGravity(r.mGravity, r.mWidth, r.mHeight</span><br><span class="line">                                           d.getIntrinsicWidth(), d.getIntrinsicHeight());</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> w = r.mWidth &lt; <span class="number">0</span> ? d.getIntrinsicWidth() : r.mWidth;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> h = r.mHeight &lt; <span class="number">0</span> ? d.getIntrinsicHeight() : r.mHeight;</span><br><span class="line">        Gravity.apply(gravity, w, h, container, outRect, layoutDirection);</span><br><span class="line">        d.setBounds(outRect);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先由<code>mLayerState</code>取出所有ChildDrawable，並然後迴圈內依序取出進行以下幾個主要操作：</p>
<ul>
<li>取出ChildDrawable內的Drawable。</li>
<li>取得目前Drawable的範圍，預設應是(0, 0) - (0, 0)。</li>
<li>經過一些相容性的調整。只要有給予寬高設定，<code>resolveGravity()</code>並不會更變目前ChildDrawable的Gravity。</li>
<li>取得目前的寬高設定。</li>
<li>透過<code>Gravity.apply()</code>完成最後範圍的調整，並存入<code>outRect</code>。</li>
<li>使用<code>outRect</code>來設定Drawable的繪製範圍。</li>
</ul>
<p>用範例給予的參數走過以上步驟，輸入<code>Gravity.apply()</code>的參數如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Gravity.apply(Gravity.BOTTOM, 0, 1, container, outRect, LayoutDirection.LTR)</span><br></pre></td></tr></table></figure>

<p>接著再來看到<code>Gravity.apply()</code>：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// In Gravity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BOTTOM = (AXIS_PULL_AFTER|AXIS_SPECIFIED)&lt;&lt;AXIS_Y_SHIFT;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">apply</span><span class="params">(<span class="keyword">int</span> gravity, <span class="keyword">int</span> w, <span class="keyword">int</span> h, Rect container, <span class="keyword">int</span> xAdj, <span class="keyword">int</span> yAdj, Rect outRect)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (gravity&amp;((AXIS_PULL_BEFORE|AXIS_PULL_AFTER)&lt;&lt;AXIS_X_SHIFT)) &#123;</span><br><span class="line">    	...</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">switch</span> (gravity&amp;((AXIS_PULL_BEFORE|AXIS_PULL_AFTER)&lt;&lt;AXIS_Y_SHIFT)) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">case</span> AXIS_PULL_AFTER&lt;&lt;AXIS_Y_SHIFT:</span><br><span class="line">          outRect.bottom = container.bottom - yAdj;</span><br><span class="line">          outRect.top = outRect.bottom - h;</span><br><span class="line">          ...</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">          ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>內容很多但就是依照當前傳入的Gravity，搭配給予的寬高設定，來決定最後的繪製範圍。而我們傳入的是Gravity.BOTTOM，對照前面的static變數就是AXIS_PULL_AFTER&lt;&lt;AXIS_Y_SHIFT。其中的操作如下：</p>
<ul>
<li><code>yAdj</code>在傳入時就是0，<code>outRect</code>的<code>bottom</code>會與原本的Drawable底部相同。</li>
<li><code>h</code>是1，所以<code>outRect</code>的<code>top</code>等於<code>bottom</code>剪掉1，藉此來達到畫面上高度為1的結果。</li>
<li><code>w</code>沒用到，所以<code>outRect</code>的<code>left</code>和<code>right</code>保持不變。</li>
</ul>
<p>所以如果container的寬高為 (x , y)，<code>outRect</code>最後的結果如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">outRect &#123; left = <span class="number">0</span>, right = x, top = y - <span class="number">1</span>, bottom = y&#125;</span><br></pre></td></tr></table></figure>

<p>所以就算container內原本是給予覆蓋整個View的範圍，也會因為設定了寬高和Gravity而再進行調整。以當前的參數來說，得到的繪製結果就是一條橫線。</p>

  </div>
  
<section id="comments">
  <div id="disqus_thread"></div>
</section>
<script>
  var disqus_shortname = 'ansgarlin';
  var disqus_url = 'https://ansgarlin.github.io/zh-tw/news/2018/03/09/why_the_shape_works_unexpectedly_in_the_layer_list_before_android_22/index.html';
  var disqus_title = "Why The Shape Works Unexpectedly In The layer-list Before Android-22?";
  var disqus_config = function(){
    this.language = 'zh_TW';
  };
  (function(){
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'https://go.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>

</article>

    </div>
  </div>
</div>
    <footer id="footer" class="wrapper">
  <div class="inner">
    <div id="footer-copyright">
      &copy; 2020 Ansgar Lin. Powered by <a href="https://hexo.io/" rel="external nofollow noreferrer" target="_blank">Hexo</a><br>
      Documentation licensed under <a href="http://creativecommons.org/licenses/by/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>.
    </div>
    <div id="footer-links">
      <a href="mailto:AnsgarLin@gmail.com" rel="external nofollow noreferrer" class="footer-link" target="_blank"><i class="fa fa-envelope"></i></a>
      <a href="https://www.linkedin.com/in/AnsgarLin" rel="external nofollow noreferrer" class="footer-link" target="_blank"><i class="fa fa-linkedin-square"></i></a>
      <a href="https://github.com/AnsgarLin" rel="external nofollow noreferrer" class="footer-link" target="_blank"><i class="fa fa-github-square"></i></a>
      <a href="https://AnsgarLin.gitbooks.io/" rel="external nofollow noreferrer" class="footer-link" target="_blank"><i class="fa fa-book"></i></a>
    </div>
  </div>
</footer>

  </div>
  <div id="mobile-nav-dimmer"></div>
  <nav id="mobile-nav">
  <div id="mobile-nav-inner">
    <ul id="mobile-nav-list">
      <a href="/news/" class="mobile-nav-link">文章</a><a href="/zh-tw/android/" class="mobile-nav-link">Android</a><a href="/zh-tw/kotlin/" class="mobile-nav-link">Kotlin</a><a href="/zh-tw/rxjava/" class="mobile-nav-link">RxJava</a>
      <li class="mobile-nav-item">
        <a href="https://github.com/AnsgarLin" class="mobile-nav-link" rel="external" target="_blank">GitHub</a>
      </li>
    </ul>
    
  </div>
  <div id="mobile-lang-select-wrap">
    <span id="mobile-lang-select-label"><i class="fa fa-globe"></i><span>正體中文</span></span>
    <select id="mobile-lang-select" data-canonical="">
      
        <option value="en">English</option>
      
        <option value="zh-tw" selected>正體中文</option>
      
    </select>
  </div>
</nav>
  <!-- Scripts -->
<!-- Cookie -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/js-cookie/2.2.0/js.cookie.min.js"></script>
<!-- build:js build/js/main.js -->

<script src="/js/lang_select.js"></script>
 
<script src="/js/toc.js"></script>
 
<script src="/js/mobile_nav.js"></script>

<!-- endbuild -->

<!-- Algolia -->

<script src="//cdn.jsdelivr.net/autocomplete.js/0/autocomplete.min.js"></script>
<script src="//cdn.jsdelivr.net/algoliasearch/3/algoliasearch.min.js"></script>
<script type="text/javascript">
    document.getElementById('search-input-wrap').classList.add('on');
    var client = algoliasearch('769KWCTEZG', 'e6a393ae2870a9ce5f88a275f04156a3');
    var index = client.initIndex('ansgar');
    autocomplete('#search-input', { 
        hint: false
    }, [
        {
          source: autocomplete.sources.hits(index, { hitsPerPage: 5 }),
          templates: {
            suggestion: function(suggestion) {
              return '<div class="algolia-docsearch-suggestion algolia-docsearch-suggestion__main algolia-docsearch-suggestion__secondary" style="white-space: normal;"><div class="algolia-docsearch-suggestion--category-header">' + 
                  suggestion._highlightResult.title.value + //<span class="algolia-docsearch-suggestion--highlight">R</span>outer
              '</div>' + 
              '<div class="algolia-docsearch-suggestion--wrapper"><div class="algolia-docsearch-suggestion--subcategory-column"><span class="algolia-docsearch-suggestion--subcategory-column-text">' +
                  suggestion._highlightResult.title.value +//<span class="algolia-docsearch-suggestion--highlight">R</span>outer</span
              '</div>' + 
              '<div class="algolia-docsearch-suggestion--content"><div class="algolia-docsearch-suggestion--subcategory-inline">' + 
                  suggestion._highlightResult.title.value +//<span class="algolia-docsearch-suggestion--highlight">R</span>outer
              '</div>' + 
              '<div class="algolia-docsearch-suggestion--title">' + 
                  suggestion._highlightResult.title.value +//<span class="algolia-docsearch-suggestion--highlight">R</span>outer
              '</div>' + 
              '<div class="algolia-docsearch-suggestion--text">' + 
                  suggestion._highlightResult.text.value +//<span class="algolia-docsearch-suggestion--highlight">R</span>outer
              '</div>' + 
//                  The <span class="algolia-docsearch-suggestion--highlight">r</span>outer saves all paths used in the site…</div>
              '</div></div></div>'
                
//              return '<a href="/material_design/">' + suggestion._highlightResult.name.value + '</a>';
//              return suggestion._highlightResult.name.value;
            }
          }
        }
      ]).on('autocomplete:selected', function(event, suggestion, dataset) {
        window.location = '/' + suggestion.path;
        return dataset.source;
//    console.log(suggestion, dataset);
    });
</script>

</body>
</html>