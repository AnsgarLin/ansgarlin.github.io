<!DOCTYPE html>
<html lang="en">
<head prefix="og: http://ogp.me/ns#">
  <meta charset="utf-8">
  <title>Thread Control | Ansgar</title>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Canonical links -->
  <link rel="canonical" href="https://ansgarlin.github.io/rxjava/thread_control.html">
  <!-- Alternative links -->
  
    
      <link rel="alternative" hreflang="en" href="https://ansgarlin.github.io/rxjava/thread_control.html">
    
      <link rel="alternative" hreflang="zh-tw" href="https://ansgarlin.github.io/zh-tw/rxjava/thread_control.html">
    
  
  <!-- Icon -->
  <link rel="apple-touch-icon" sizes="57x57" href="/icon/apple-touch-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/icon/apple-touch-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/icon/apple-touch-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/icon/apple-touch-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/icon/apple-touch-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/icon/apple-touch-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/icon/apple-touch-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icon/apple-touch-icon-152x152.png">
  <link rel="icon" type="image/png" href="/icon/favicon-196x196.png" sizes="196x196">
  <link rel="icon" type="image/png" href="/icon/favicon-160x160.png" sizes="160x160">
  <link rel="icon" type="image/png" href="/icon/favicon-96x96.png" sizes="96x96">
  <link rel="icon" type="image/png" href="/icon/favicon-16x16.png" sizes="16x16">
  <link rel="icon" type="image/png" href="/icon/favicon-32x32.png" sizes="32x32">
  <meta name="msapplication-TileColor" content="#2f83cd">
  <meta name="msapplication-TileImage" content="/icon/mstile-144x144.png">
  <meta name="generator" content="Hexo 5.2.0">
  <!-- CSS -->
  <!-- build:css build/css/navy.css -->
  
<link rel="stylesheet" href="/css/navy.css">

  <!-- endbuild -->
  <link href="https://fonts.googleapis.com/css?family=Lato:300,400,700" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css">
  <!-- RSS -->
  <link rel="alternate" href="/atom.xml" title="Ansgar" type="application/atom+xml">
  <!-- Open Graph -->
  <meta name="description" content="Thread controlling is one of the specialists of RaJava. By switching time spend process to the other thread, we can avoid the effections on the react time of the screen.  There are two methods which a">
<meta property="og:type" content="website">
<meta property="og:title" content="Thread Control">
<meta property="og:url" content="https://ansgarlin.github.io/rxjava/thread_control.html">
<meta property="og:site_name" content="Ansgar">
<meta property="og:description" content="Thread controlling is one of the specialists of RaJava. By switching time spend process to the other thread, we can avoid the effections on the react time of the screen.  There are two methods which a">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2020-11-07T10:14:05.264Z">
<meta property="article:modified_time" content="2020-11-07T10:14:05.264Z">
<meta property="article:author" content="Ansgar Lin">
<meta name="twitter:card" content="summary">
  <!-- Google Analytics -->
  
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-6482217598104186",
          enable_page_level_ads: true
     });
  </script>
</head>

<body>
  <div id="container">
    <header id="header" class="wrapper">
  <div id="header-inner" class="inner">
    <a href="/" class="main-nav-link"><i class="fa fa-home"></i></a>
    <nav id="main-nav">
      <a href="/android/" class="main-nav-link">Android</a><a href="/kotlin/" class="main-nav-link">Kotlin</a><a href="/rxjava/" class="main-nav-link">RxJava</a>
      <a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/AnsgarLin" class="main-nav-link"><i class="fa fa-github-alt"></i></a>
    </nav>
    <div id="lang-select-wrap">
      <label id="lang-select-label"><i class="fa fa-globe"></i><span>English</span></label>
      <select id="lang-select" data-canonical="rxjava/thread_control.html">
        
          <option value="en" selected>English</option>
        
          <option value="zh-tw">正體中文</option>
        
      </select>
    </div>
    <a id="mobile-nav-toggle">
      <span class="mobile-nav-toggle-bar"></span>
      <span class="mobile-nav-toggle-bar"></span>
      <span class="mobile-nav-toggle-bar"></span>
    </a>
  </div>
</header>

    <div id="content-wrap">
  <div id="content" class="wrapper">
    <div id="content-inner">
      <article class="article-container" itemscope itemtype="http://schema.org/Article">
        <div class="article-inner">
          <div class="article">
            <div class="inner">
              <header class="article-header">
                <h1 class="article-title" itemprop="name">Thread Control</h1>
              </header>
              <div class="article-content" itemprop="articleBody">
                <p>Thread controlling is one of the specialists of RaJava. By switching time spend process to the other thread, we can avoid the effections on the react time of the screen. </p>
<p>There are two methods which are used to do the thread controlling in RxJava: <code>subscribeOn()</code> and <code>observeOn()</code>. Accrofding to the “Basic Concept”, we know that <code>subscribeOn()</code> is reponsible to decide the thread to send data, and <code>observeOn()</code> is used to decide on which thread the operator will be executed.</p>
<p>It’s suggested to read “Basic Concept” before continuing on the ariticle. There are concepts that already introduce in “Basic Concept” and will be used in this article.</p>
<blockquote>
<p><a href="basic_concept.html">Basic Concept</a></p>
</blockquote>
<p>Here are the example we will use, which is the same as “Basic Concept”:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Observable.create(<span class="keyword">new</span> ObservableOnSubscribe&lt;Integer&gt;() &#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(ObservableEmitter&lt;Integer&gt; e)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    e.onNext(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line">  .subscribeOn(Schedulers.newThread())</span><br><span class="line">  .observeOn(AndroidSchedulers.mainThread())</span><br><span class="line">  .subscribe(<span class="keyword">new</span> Consumer&lt;String&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(String s)</span> <span class="keyword">throws</span> Exception </span>&#123; &#125;</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>
<h3 id="subscribeOn" class="article-heading"><a href="#subscribeOn" class="headerlink" title="subscribeOn()"></a>subscribeOn()<a class="article-anchor" href="#subscribeOn" aria-hidden="true"></a></h3><p>When using <code>subscribeOn()</code>, we need to pass the Scheduler into it and get an ObservableSubscribeOn:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">.subscribeOn(Schedulers.newThread())</span><br></pre></td></tr></table></figure>

<p>And the Scheduler will be used in <code>subscribeActual()</code>:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// In ObservableSubscribeOn</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribeActual</span><span class="params">(<span class="keyword">final</span> Observer&lt;? <span class="keyword">super</span> T&gt; s)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> SubscribeOnObserver&lt;T&gt; parent = <span class="keyword">new</span> SubscribeOnObserver&lt;T&gt;(s);</span><br><span class="line">  s.onSubscribe(parent);</span><br><span class="line">  parent.setDisposable(scheduler.scheduleDirect(<span class="keyword">new</span> SubscribeTask(parent)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The SubscribeTask can be seen as a Runnable.</p>
<p>In <code>scheduleDirect()</code>:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Scheduler</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Disposable <span class="title">scheduleDirect</span><span class="params">(<span class="meta">@NonNull</span> Runnable run, <span class="keyword">long</span> delay, <span class="meta">@NonNull</span> TimeUnit unit)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> Worker w = createWorker();</span><br><span class="line">  <span class="keyword">final</span> Runnable decoratedRun = RxJavaPlugins.onSchedule(run);</span><br><span class="line">  DisposeTask task = <span class="keyword">new</span> DisposeTask(decoratedRun, w);</span><br><span class="line">  w.schedule(task, delay, unit);</span><br><span class="line">  <span class="keyword">return</span> task;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Use <code>createWorker()</code> to get a Worker, and get passed into DisposeTask with the Runnable from outside, which is the SubscribeTask:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// In DisposeTask</span></span><br><span class="line">DisposeTask(Runnable decoratedRun, Worker w) &#123;</span><br><span class="line">  <span class="keyword">this</span>.decoratedRun = decoratedRun;</span><br><span class="line">  <span class="keyword">this</span>.w = w;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>There are only assignments In the constrouctor of DisposeTask, so DisposeTask is only for wrapping the SubscribeTask and the Worker together.</p>
<p>Then we look back to the <code>subscribe()</code> of Worker. Because there is no implementation of <code>schedule()</code> in Worker, we need to trace back to the <code>createWorker()</code>:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// In Scheduler</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> Worker <span class="title">createWorker</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>

<p>Turn out the <code>createWorker()</code> of Scheduler is also an abstract method. So we need to look what kind of Schedule that we use, which is the parameter that we use when calling <code>subscribeOn()</code>, <code>Schedulers.newThread()</code>：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// In Schedulers</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Scheduler <span class="title">newThread</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> RxJavaPlugins.onNewThreadScheduler(NEW_THREAD);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The NEW_THREAD will be NewThreadScheduler in the end, the detail will be introduced in the final chapter.</p>
<p>Continue on the <code>createWorker()</code>, we can find its implementation in the NewThreadScheduler:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// In NewThreadScheduler</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Worker <span class="title">createWorker</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> NewThreadWorker(threadFactory);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>In NewThreadWorker：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// In NewThreadWorker</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ScheduledExecutorService executor;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">NewThreadWorker</span><span class="params">(ThreadFactory threadFactory)</span> </span>&#123;</span><br><span class="line">  executor = SchedulerPoolFactory.create(threadFactory);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>NewThreadWorker will use the ThreadFactory to create a ScheduledExecutorService, which is the ScheduledThreadPoolExecutor, and implement the <code>subedule()</code>:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// In NewThreadWorker</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Disposable <span class="title">schedule</span><span class="params">(<span class="meta">@NonNull</span> <span class="keyword">final</span> Runnable action, <span class="keyword">long</span> delayTime, <span class="meta">@NonNull</span> TimeUnit unit)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">return</span> scheduleActual(action, delayTime, unit, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> ScheduledRunnable <span class="title">scheduleActual</span><span class="params">(<span class="keyword">final</span> Runnable run, <span class="keyword">long</span> delayTime, <span class="meta">@NonNull</span> TimeUnit unit, <span class="meta">@Nullable</span> DisposableContainer parent)</span> </span>&#123;</span><br><span class="line">  Runnable decoratedRun = RxJavaPlugins.onSchedule(run);</span><br><span class="line">  ScheduledRunnable sr = <span class="keyword">new</span> ScheduledRunnable(decoratedRun, parent);</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">if</span> (delayTime &lt;= <span class="number">0L</span>) &#123;</span><br><span class="line">    f = executor.submit((Callable&lt;Object&gt;)sr);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">    f = executor.schedule((Callable&lt;Object&gt;)sr, delayTime, unit);    </span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// In ScheduleRunnable</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ScheduledRunnable</span><span class="params">(Runnable actual, DisposableContainer parent)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.actual = actual;</span><br><span class="line">  <span class="keyword">this</span>.lazySet(<span class="number">0</span>, parent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The Runnable, which is DisposeTask, will be wrapped into ScheduledRunnable. And get executed by the executor, which is the ScheduledExecutorService.</p>
<p>So far, that’s see the strcuture of ScheduledRunnable:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ScheduledRunnable &#123;</span><br><span class="line">  actual = DisposeTask &#123;</span><br><span class="line">    decoratedRun = SubscribeTask &#123;</span><br><span class="line">      parent = SubscribeOnObserver      </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>When the ScheduledRunnable get executed:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// In ScheduledRunnable</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  actual.run();</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The actual, which is DisposeTask will be used to call <code>run()</code>:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// In DisposeTask</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  decoratedRun.run();</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>And the decoratedRun, which is SubscribeTask will be used to call <code>run()</code>:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// In SubscribeTask</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  source.subscribe(parent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Here we recall the two concepts in the “Basic Concept”:</p>
<ul>
<li><strong>Every Observable’s constructor is to wrap the upstream Observable.</strong></li>
<li><strong>Every Observer’s constructor is to wrap the downstream Observer.</strong></li>
</ul>
<p>So we know that the source here is the operator from the upstream, and the parent is the downstream Observer.</p>
<p>Because the <code>subscribe()</code> is in a Runnable, and get executed by the NewThreadWorker’s ScheduledExecutorService. Start from this point, every operators’ <code>subscribe()</code> of the upstream Observerble will be executed on the NewThread.</p>
<p>Here we have another concept:</p>
<ul>
<li><strong>In source code, the timing of a Worker calls <code>schedule()</code>, is the timing of thread switching.</strong></li>
</ul>
<p>Base on the concept, we can know the <code>e.onNext()</code> in the <code>subscribe()</code> of the ObservableOnSubscribe is executed on the NewThread.</p>
<p>Beside, if calling <code>subscribeOn()</code> more than once, it will swith the thread from bottom to top. In this case, we come out an new concept:</p>
<ul>
<li><strong>For <code>subscribeOn()</code>, only the closest one to the source is work.</strong></li>
</ul>
<h3 id="observeOn" class="article-heading"><a href="#observeOn" class="headerlink" title="observeOn()"></a>observeOn()<a class="article-anchor" href="#observeOn" aria-hidden="true"></a></h3><p>Now we talk about how the <code>observeOn()</code> to do the thred controling:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">.observeOn(AndroidSchedulers.mainThread())</span><br></pre></td></tr></table></figure>

<p>And the Scheduler will be used in the<code>subscribeActual()</code>:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// In ObservableObserveOn</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">subscribeActual</span><span class="params">(Observer&lt;? <span class="keyword">super</span> T&gt; observer)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  Scheduler.Worker w = scheduler.createWorker();</span><br><span class="line">  source.subscribe(<span class="keyword">new</span> ObserveOnObserver&lt;T&gt;(observer, w, delayError, bufferSize));</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The Worker will be used in the <code>schedule()</code> of the ObserveOnObserver:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// In ObserveOnObserver</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(T t)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  schedule();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">schedule</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  worker.schedule(<span class="keyword">this</span>);</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>According to the concept from the previous content, we know the <code>schedule()</code> is the start of thread switching.</p>
<p>We know the <code>worker.schedule()</code> is called because  <code>onNext()</code> will call to <code>schedule()</code>. So the <code>observeOn()</code> switches the thread when sending data. If we call the <code>observeOn()</code> more than one times, it will only effect on the downstream operators:</p>
<ul>
<li><strong><code>observeOn()</code> can be used multipletime.</strong></li>
</ul>
<h3 id="Going-to-deeper" class="article-heading"><a href="#Going-to-deeper" class="headerlink" title="Going to deeper"></a>Going to deeper<a class="article-anchor" href="#Going-to-deeper" aria-hidden="true"></a></h3><p>We have already introduced how the <code>subscribeOn</code> or <code>observeOn()</code> control the thread and how they works. But there are no any operations directly to the thread controlling.</p>
<p>So here is the big question: <strong>Where is the thread created and activated?</strong></p>
<p>Because thread is controlled by the Scheduler, so we can sure that the new thread is not created before the Scheduler is not assigned. Hense we can assume there are two places the Scheduler will create new thread:</p>
<ul>
<li><p>Assign a Scheduler.</p>
</li>
<li><p>When a Worker of the Scheduler call <code>schedule()</code>.</p>
</li>
</ul>
<h4 id="Assign-a-Scheduler" class="article-heading"><a href="#Assign-a-Scheduler" class="headerlink" title="Assign a Scheduler"></a>Assign a Scheduler<a class="article-anchor" href="#Assign-a-Scheduler" aria-hidden="true"></a></h4><p>In the implementation of Android, <code>observeOn()</code> will generally use Android’s main thread, which is already activated. So we use the <code>subscribeOn()</code> as example:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">.subscribeOn(Schedulers.newThread())</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// In Schedulers</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Scheduler <span class="title">newThread</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> RxJavaPlugins.onNewThreadScheduler(NEW_THREAD);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Here we use a constant variable NEW_THREAD. That’s look the related code:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// In Schedulers</span></span><br><span class="line"><span class="meta">@NonNull</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> Scheduler NEW_THREAD;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">NewThreadHolder</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> Scheduler DEFAULT = <span class="keyword">new</span> NewThreadScheduler();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">  NEW_THREAD = RxJavaPlugins.initNewThreadScheduler(<span class="keyword">new</span> NewThreadTask());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Scheduler <span class="title">initNewThreadScheduler</span><span class="params">(<span class="meta">@NonNull</span> Callable&lt;Scheduler&gt; defaultScheduler)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">return</span> callRequireNonNull(defaultScheduler);</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> Scheduler <span class="title">callRequireNonNull</span><span class="params">(<span class="meta">@NonNull</span> Callable&lt;Scheduler&gt; s)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">return</span> ObjectHelper.requireNonNull(s.call(), <span class="string">&quot;Scheduler Callable result can&#x27;t be null&quot;</span>);</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">NewThreadTask</span> <span class="keyword">implements</span> <span class="title">Callable</span>&lt;<span class="title">Scheduler</span>&gt; </span>&#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Scheduler <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> NewThreadHolder.DEFAULT;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>There is a static constructor, we know here must be the start place of the whole process: </p>
<ul>
<li>Pass the NewThreadTask to the <code>initNewThreadScheduler()</code>.</li>
<li>The NewThreadTask’s <code>call()</code> will be executed.</li>
<li>Get the <code>NewThreadHolder.Default</code>, which is a NewThreadScheduler, and assign to the NEW_THREAD.</li>
</ul>
<p>In the constructor of the NewThreadScheduler:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// In NewThreadScheduler</span></span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">  THREAD_FACTORY = <span class="keyword">new</span> RxThreadFactory(THREAD_NAME_PREFIX, priority);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">NewThreadScheduler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>(THREAD_FACTORY);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This is the whole process of creating and assigning a Scheduler, but still there is no any machenism about creating thread. So the first assumption is not valid, that’s continue on the other assimption.</p>
<h4 id="When-a-Worker-of-the-Scheduler-call-schedule" class="article-heading"><a href="#When-a-Worker-of-the-Scheduler-call-schedule" class="headerlink" title="When a Worker of the Scheduler call schedule()"></a>When a Worker of the Scheduler call schedule()<a class="article-anchor" href="#When-a-Worker-of-the-Scheduler-call-schedule" aria-hidden="true"></a></h4><p>From the previous chapter, <code>Worker.schedule()</code> will use the <code>submit()</code> or <code>schedule()</code> of the ScheduledThreadPoolExecutor:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// In ScheduledThreadPoolExecutor</span></span><br><span class="line"><span class="keyword">public</span> Future&lt;?&gt; submit(Runnable task) &#123;</span><br><span class="line">  <span class="keyword">return</span> schedule(task, <span class="number">0</span>, NANOSECONDS);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> ScheduledFuture&lt;?&gt; schedule(Runnable command, <span class="keyword">long</span> delay, TimeUnit unit) &#123;</span><br><span class="line">  ...</span><br><span class="line">  RunnableScheduledFuture&lt;Void&gt; t = decorateTask(command, <span class="keyword">new</span> ScheduledFutureTask&lt;Void&gt;(command, <span class="keyword">null</span>, triggerTime(delay, unit), sequencer.getAndIncrement()));</span><br><span class="line">  delayedExecute(t);</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">delayedExecute</span><span class="params">(RunnableScheduledFuture&lt;?&gt; task)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">super</span>.getQueue().add(task);</span><br><span class="line">  ...</span><br><span class="line">  ensurePrestart()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>No matter the <code>submit()</code> or <code>schedule()</code>, both of them will end up at <code>delayedExecute()</code>. And continue on  <code>ensurePrestart()</code>:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// In ThreadPoolExecutor</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ensurePrestart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  addWorker(<span class="keyword">null</span>, <span class="keyword">true</span>);</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Worker</span> </span>&#123;</span><br><span class="line">  Worker(Runnable firstTask) &#123;</span><br><span class="line">    setState(-<span class="number">1</span>); <span class="comment">// inhibit interrupts until runWorker</span></span><br><span class="line">    <span class="keyword">this</span>.firstTask = firstTask;</span><br><span class="line">    <span class="keyword">this</span>.thread = getThreadFactory().newThread(<span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">addWorker</span><span class="params">(Runnable firstTask, <span class="keyword">boolean</span> core)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  w = <span class="keyword">new</span> Worker(firstTask);</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">final</span> Thread t = w.thread;</span><br><span class="line">  ...</span><br><span class="line">  t.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>From <code>ensurePrestart()</code> to <code>addWorker()</code>, here we see an inner class Worker of the ThreadPoolExecutor, which will use the ThreadFactory to call the <code>newThread()</code> in its constructor.</p>
<p>Base on previous content, the THREAD_FACTORY, which is RxThreadFactory, will be passed into the NewThreadWorker when the NewThreadScheduler try to create one.</p>
<p>The ThreadFactory will be passed to the ScheduledThreadPoolExecutor. <code>getThreadFactory().newThread()</code> is actually <code>RxThreadFactory.newThread()</code>:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// In RxThreadFactory</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Thread <span class="title">newThread</span><span class="params">(Runnable r)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  Thread t = nonBlocking ? <span class="keyword">new</span> RxCustomThread(r, name) : <span class="keyword">new</span> Thread(r, name);</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">RxCustomThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> <span class="keyword">implements</span> <span class="title">NonBlockingThread</span> </span>&#123;</span><br><span class="line">  RxCustomThread(Runnable run, String name) &#123;</span><br><span class="line">    <span class="keyword">super</span>(run, name);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Here we finally see a Thread is created</strong>, which use the constructor of the Thread:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// In Thread</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Thread</span><span class="params">(Runnable target, String name)</span> </span>&#123;</span><br><span class="line">  init(<span class="keyword">null</span>, target, name, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ThreadGroup g, Runnable target, String name, <span class="keyword">long</span> stackSize)</span> </span>&#123;</span><br><span class="line">  Thread parent = currentThread();</span><br><span class="line">  <span class="keyword">if</span> (g == <span class="keyword">null</span>) &#123;</span><br><span class="line">    g = parent.getThreadGroup();</span><br><span class="line">  &#125;</span><br><span class="line">  g.addUnstarted();</span><br><span class="line">  <span class="keyword">this</span>.group = g;</span><br><span class="line">  <span class="keyword">this</span>.target = target;</span><br><span class="line">  <span class="keyword">this</span>.priority = parent.getPriority();</span><br><span class="line">  <span class="keyword">this</span>.daemon = parent.isDaemon();</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>There are only assignments in the constructor of Thread, and use ThreadGroup to call the <code>addUnstarted()</code>. Bsed on the comment of the <code>addUnstarted()</code> in the Java document, the purpose is to notify the ThreadGroup about new thread, not to change the list of on-going thread.</p>
<p>Back to <code>addWorker()</code>, call the <code>start()</code> of Thread in the end:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// In Thread</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  group.add(<span class="keyword">this</span>);</span><br><span class="line">  ...</span><br><span class="line">  nativeCreate(<span class="keyword">this</span>, stackSize, daemon);</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Here use <code>add()</code> of the ThreadGroup to notify the new Thread is about to be activated, and add into on-going Thread list. Then execute <code>run()</code> of the Thread with a native function, <strong>the thread is finally activated until now</strong>: </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// In Thread</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (target != <span class="keyword">null</span>) &#123;</span><br><span class="line">    target.run();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Now the <code>run()</code> is runned on the new thread.</p>
<p>The target is a Runnable from outside when the Thread is created, which can be traced back to the ThreadPoolExecutor.Worker’s constructor：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// In ThreadPoolExecutor.Worker</span></span><br><span class="line"><span class="keyword">this</span>.thread = getThreadFactory().newThread(<span class="keyword">this</span>);</span><br></pre></td></tr></table></figure>

<p>The target is the Worker itself, so that’s continue on the <code>run()</code> of Worker:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// In ThreadPoolExecutor.Worker</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  runWorker(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">runWorker</span><span class="params">(Worker w)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">while</span> (task != <span class="keyword">null</span> || (task = getTask()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">    ...</span><br><span class="line">    task.run();</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Go a long way around, here we see the part of executing the task. The task is the DisposeTask that is passed when calling the <code>scheduleDirect()</code>.</p>
<p>At the end we finally confirm the timing of creating and activating thread, and the whole process is:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ObservableSubscribeOn.subscribeActual</span><br><span class="line">-&gt; Scheduler.scheduleDirect</span><br><span class="line">-&gt; Worker.schedule</span><br><span class="line">-&gt; ScheduledThreadPoolExecutor.schedule</span><br><span class="line">-&gt; ScheduledThreadPoolExecutor.delayExecute</span><br><span class="line">-&gt; ThreadPoolExecutor.ensurePrestart</span><br><span class="line">-&gt; ThreadPoolExecutor.addWorker &#123;</span><br><span class="line">	 w = <span class="keyword">new</span> Worker(firstTask) &#123;</span><br><span class="line">     	   Thread thread = getThreadFactory().newThread()            </span><br><span class="line">         &#125;;</span><br><span class="line">     <span class="keyword">final</span> Thread t = w.thread;</span><br><span class="line">     t.start();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>



              </div>
              <footer class="article-footer">
                <time class="article-footer-updated" datetime="2020-11-07T10:14:05.264Z" itemprop="dateModified">Last updated: 2020-11-07</time>
                <a href="basic_concept.html" class="article-footer-prev" title="Basic Concept"><i class="fa fa-chevron-left"></i><span>Prev</span></a><a href="compose_and_lift.html" class="article-footer-next" title="compose() & lift()"><span>Next</span><i class="fa fa-chevron-right"></i></a>
              </footer>
              
<section id="comments">
  <div id="disqus_thread"></div>
</section>
<script>
  var disqus_shortname = 'ansgarlin';
  var disqus_url = 'https://ansgarlin.github.io/rxjava/thread_control.html';
  var disqus_title = "Thread Control";
  var disqus_config = function(){
    this.language = 'en';
  };
  (function(){
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'https://go.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>

            </div>
          </div>
          <aside id="article-toc" role="navigation">
            <div id="article-toc-inner">
              <strong class="sidebar-title">Contents</strong>
              <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#subscribeOn"><span class="toc-text">subscribeOn()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#observeOn"><span class="toc-text">observeOn()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Going-to-deeper"><span class="toc-text">Going to deeper</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Assign-a-Scheduler"><span class="toc-text">Assign a Scheduler</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#When-a-Worker-of-the-Scheduler-call-schedule"><span class="toc-text">When a Worker of the Scheduler call schedule()</span></a></li></ol></li></ol>
              <a href="#" id="article-toc-top">Back to Top</a>
            </div>
          </aside>
        </div>
      </article>
      <aside id="sidebar" role="navigation">
  <div class="inner">
    <strong class="sidebar-title">Introduction</strong><a href="index.html" class="sidebar-link">Overview</a><strong class="sidebar-title">Source Analysis</strong><a href="basic_concept.html" class="sidebar-link">Basic Concept</a><a href="thread_control.html" class="sidebar-link current">Thread Control</a><a href="compose_and_lift.html" class="sidebar-link">compose() & lift()</a><a href="groupby.html" class="sidebar-link">groupBy()</a><strong class="sidebar-title">Decision Table</strong><a href="creation_operator_decision_table.html" class="sidebar-link">Creation Operator</a><a href="instance_operator_decision_table.html" class="sidebar-link">Instance Operator</a><strong class="sidebar-title">Others</strong><a href="error_handle.html" class="sidebar-link">Error Handle</a><a href="caveat_about_merge_method.html" class="sidebar-link">Caveat about merge method</a><a href="not_rxjava_guide_for_lazy_folks.html" class="sidebar-link">Not RxJava Guide For Lazy Folks</a>
  </div>
</aside>
    </div>
  </div>
</div>

    <footer id="footer" class="wrapper">
  <div class="inner">
    <div id="footer-copyright">
      &copy; 2020 Ansgar Lin. Powered by <a href="https://hexo.io/" rel="external nofollow noreferrer" target="_blank">Hexo</a><br>
      Documentation licensed under <a href="http://creativecommons.org/licenses/by/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>.
    </div>
    <div id="footer-links">
      <a href="mailto:AnsgarLin@gmail.com" rel="external nofollow noreferrer" class="footer-link" target="_blank"><i class="fa fa-envelope"></i></a>
      <a href="https://www.linkedin.com/in/AnsgarLin" rel="external nofollow noreferrer" class="footer-link" target="_blank"><i class="fa fa-linkedin-square"></i></a>
      <a href="https://github.com/AnsgarLin" rel="external nofollow noreferrer" class="footer-link" target="_blank"><i class="fa fa-github-square"></i></a>
      <a href="https://AnsgarLin.gitbooks.io/" rel="external nofollow noreferrer" class="footer-link" target="_blank"><i class="fa fa-book"></i></a>
    </div>
  </div>
</footer>

  </div>
  <div id="mobile-nav-dimmer"></div>
  <nav id="mobile-nav">
  <div id="mobile-nav-inner">
    <ul id="mobile-nav-list">
      <a href="/android/" class="mobile-nav-link">Android</a><a href="/kotlin/" class="mobile-nav-link">Kotlin</a><a href="/rxjava/" class="mobile-nav-link">RxJava</a>
      <li class="mobile-nav-item">
        <a href="https://github.com/AnsgarLin" class="mobile-nav-link" rel="external" target="_blank">GitHub</a>
      </li>
    </ul>
    
      <strong class="mobile-nav-title">Introduction</strong><a href="index.html" class="mobile-nav-link">Overview</a><strong class="mobile-nav-title">Source Analysis</strong><a href="basic_concept.html" class="mobile-nav-link">Basic Concept</a><a href="thread_control.html" class="mobile-nav-link current">Thread Control</a><a href="compose_and_lift.html" class="mobile-nav-link">compose() & lift()</a><a href="groupby.html" class="mobile-nav-link">groupBy()</a><strong class="mobile-nav-title">Decision Table</strong><a href="creation_operator_decision_table.html" class="mobile-nav-link">Creation Operator</a><a href="instance_operator_decision_table.html" class="mobile-nav-link">Instance Operator</a><strong class="mobile-nav-title">Others</strong><a href="error_handle.html" class="mobile-nav-link">Error Handle</a><a href="caveat_about_merge_method.html" class="mobile-nav-link">Caveat about merge method</a><a href="not_rxjava_guide_for_lazy_folks.html" class="mobile-nav-link">Not RxJava Guide For Lazy Folks</a>
    
  </div>
  <div id="mobile-lang-select-wrap">
    <span id="mobile-lang-select-label"><i class="fa fa-globe"></i><span>English</span></span>
    <select id="mobile-lang-select" data-canonical="rxjava/thread_control.html">
      
        <option value="en" selected>English</option>
      
        <option value="zh-tw">正體中文</option>
      
    </select>
  </div>
</nav>
  <!-- Scripts -->
<!-- Cookie -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/js-cookie/2.2.0/js.cookie.min.js"></script>
<!-- build:js build/js/main.js -->

<script src="/js/lang_select.js"></script>
 
<script src="/js/toc.js"></script>
 
<script src="/js/mobile_nav.js"></script>

<!-- endbuild -->

<!-- Algolia -->

<script src="//cdn.jsdelivr.net/autocomplete.js/0/autocomplete.min.js"></script>
<script src="//cdn.jsdelivr.net/algoliasearch/3/algoliasearch.min.js"></script>
<script type="text/javascript">
    document.getElementById('search-input-wrap').classList.add('on');
    var client = algoliasearch('769KWCTEZG', 'e6a393ae2870a9ce5f88a275f04156a3');
    var index = client.initIndex('ansgar');
    autocomplete('#search-input', { 
        hint: false
    }, [
        {
          source: autocomplete.sources.hits(index, { hitsPerPage: 5 }),
          templates: {
            suggestion: function(suggestion) {
              return '<div class="algolia-docsearch-suggestion algolia-docsearch-suggestion__main algolia-docsearch-suggestion__secondary" style="white-space: normal;"><div class="algolia-docsearch-suggestion--category-header">' + 
                  suggestion._highlightResult.title.value + //<span class="algolia-docsearch-suggestion--highlight">R</span>outer
              '</div>' + 
              '<div class="algolia-docsearch-suggestion--wrapper"><div class="algolia-docsearch-suggestion--subcategory-column"><span class="algolia-docsearch-suggestion--subcategory-column-text">' +
                  suggestion._highlightResult.title.value +//<span class="algolia-docsearch-suggestion--highlight">R</span>outer</span
              '</div>' + 
              '<div class="algolia-docsearch-suggestion--content"><div class="algolia-docsearch-suggestion--subcategory-inline">' + 
                  suggestion._highlightResult.title.value +//<span class="algolia-docsearch-suggestion--highlight">R</span>outer
              '</div>' + 
              '<div class="algolia-docsearch-suggestion--title">' + 
                  suggestion._highlightResult.title.value +//<span class="algolia-docsearch-suggestion--highlight">R</span>outer
              '</div>' + 
              '<div class="algolia-docsearch-suggestion--text">' + 
                  suggestion._highlightResult.text.value +//<span class="algolia-docsearch-suggestion--highlight">R</span>outer
              '</div>' + 
//                  The <span class="algolia-docsearch-suggestion--highlight">r</span>outer saves all paths used in the site…</div>
              '</div></div></div>'
                
//              return '<a href="/material_design/">' + suggestion._highlightResult.name.value + '</a>';
//              return suggestion._highlightResult.name.value;
            }
          }
        }
      ]).on('autocomplete:selected', function(event, suggestion, dataset) {
        window.location = '/' + suggestion.path;
        return dataset.source;
//    console.log(suggestion, dataset);
    });
</script>

</body>
</html>