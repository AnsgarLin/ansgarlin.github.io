<!DOCTYPE html>
<html lang="en">
<head prefix="og: http://ogp.me/ns#">
  <meta charset="utf-8">
  <title>OOM - WebP | Ansgar</title>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Canonical links -->
  <link rel="canonical" href="https://ansgarlin.github.io/en/news/2019/07/04/oom_webp/index.html">
  <!-- Alternative links -->
  
  <!-- Icon -->
  <link rel="apple-touch-icon" sizes="57x57" href="/icon/apple-touch-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/icon/apple-touch-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/icon/apple-touch-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/icon/apple-touch-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/icon/apple-touch-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/icon/apple-touch-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/icon/apple-touch-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icon/apple-touch-icon-152x152.png">
  <link rel="icon" type="image/png" href="/icon/favicon-196x196.png" sizes="196x196">
  <link rel="icon" type="image/png" href="/icon/favicon-160x160.png" sizes="160x160">
  <link rel="icon" type="image/png" href="/icon/favicon-96x96.png" sizes="96x96">
  <link rel="icon" type="image/png" href="/icon/favicon-16x16.png" sizes="16x16">
  <link rel="icon" type="image/png" href="/icon/favicon-32x32.png" sizes="32x32">
  <meta name="msapplication-TileColor" content="#2f83cd">
  <meta name="msapplication-TileImage" content="/icon/mstile-144x144.png">
  <meta name="generator" content="Hexo 5.2.0">
  <!-- CSS -->
  <!-- build:css build/css/navy.css -->
  
<link rel="stylesheet" href="/css/navy.css">

  <!-- endbuild -->
  <link href="https://fonts.googleapis.com/css?family=Lato:300,400,700" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css">
  <!-- RSS -->
  <link rel="alternate" href="/atom.xml" title="Ansgar" type="application/atom+xml">
  <!-- Open Graph -->
  <meta name="description" content="WebP is an image format which is both lossy and lossless compression. Widely used in all Android app, including us. If you wish to get more detail about WebP, please check the following link:  Google&#x2F;">
<meta property="og:type" content="article">
<meta property="og:title" content="OOM - WebP">
<meta property="og:url" content="https://ansgarlin.github.io/en/news/2019/07/04/oom_webp/index.html">
<meta property="og:site_name" content="Ansgar">
<meta property="og:description" content="WebP is an image format which is both lossy and lossless compression. Widely used in all Android app, including us. If you wish to get more detail about WebP, please check the following link:  Google&#x2F;">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://ansgarlin.github.io/en/news/2019/07/04/oom_webp/error.png">
<meta property="og:image" content="https://ansgarlin.github.io/en/news/2019/07/04/oom_webp/stacktrace_1.png">
<meta property="og:image" content="https://ansgarlin.github.io/en/news/2019/07/04/oom_webp/stacktrace_2.png">
<meta property="og:image" content="https://ansgarlin.github.io/en/news/2019/07/04/oom_webp/image.png">
<meta property="og:image" content="https://ansgarlin.github.io/en/news/2019/07/04/oom_webp/distribution.png">
<meta property="article:published_time" content="2019-07-04T00:00:00.000Z">
<meta property="article:modified_time" content="2020-11-07T10:14:05.049Z">
<meta property="article:author" content="Ansgar Lin">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://ansgarlin.github.io/en/news/2019/07/04/oom_webp/error.png">
  <!-- Google Analytics -->
  
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-6482217598104186",
          enable_page_level_ads: true
     });
  </script>
</head>

<body>
  <div id="container">
    <header id="header" class="wrapper">
  <div id="header-inner" class="inner">
    <a href="/" class="main-nav-link"><i class="fa fa-home"></i></a>
    <nav id="main-nav">
      <a href="/news/" class="main-nav-link">Post</a><a href="/android/" class="main-nav-link">Android</a><a href="/kotlin/" class="main-nav-link">Kotlin</a><a href="/rxjava/" class="main-nav-link">RxJava</a>
      <a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/AnsgarLin" class="main-nav-link"><i class="fa fa-github-alt"></i></a>
    </nav>
    <div id="lang-select-wrap">
      <label id="lang-select-label"><i class="fa fa-globe"></i><span>English</span></label>
      <select id="lang-select" data-canonical="">
        
          <option value="en" selected>English</option>
        
          <option value="zh-tw">正體中文</option>
        
      </select>
    </div>
    <a id="mobile-nav-toggle">
      <span class="mobile-nav-toggle-bar"></span>
      <span class="mobile-nav-toggle-bar"></span>
      <span class="mobile-nav-toggle-bar"></span>
    </a>
  </div>
</header>

    <div id="content-wrap">
  <div class="wrapper">
    <div class="inner">
      <article class="article post" itemscope itemtype="http://schema.org/Article">
  <header class="article-header">
    
      <h1 class="article-title" itemprop="name">OOM - WebP</h1>
    
    <a href="/en/news/2019/07/04/oom_webp/" class="article-date"><time datetime="2019-07-04T00:00:00.000Z">2019-07-04</time></a>
  </header>
  <div class="article-content" itemprop="articleBody">
    <p>WebP is an image format which is both lossy and lossless compression. Widely used in all Android app, including us. If you wish to get more detail about WebP, please check the following link:</p>
<ul>
<li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://developers.google.com/speed/webp/">Google/WebP</a></li>
<li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://medium.com/@duhroach/how-webp-works-lossly-mode-33bd2b1d0670">How WebP works (lossly mode)</a></li>
</ul>
<h3 id="Why-WebP" class="article-heading"><a href="#Why-WebP" class="headerlink" title="Why WebP"></a>Why WebP<a class="article-anchor" href="#Why-WebP" aria-hidden="true"></a></h3><p>We use WebP heavily inside the project not just because it save the network bandwidth but also cut down size for all image resources to save APK size.</p>
<p>But if you don’t pay attention to the bitmap size that it will become at Runtime, you may go into OOM error like us.</p>
<p><img src="error.png" alt="error"></p>
<h3 id="How-does-it-happen" class="article-heading"><a href="#How-does-it-happen" class="headerlink" title="How does it happen"></a>How does it happen<a class="article-anchor" href="#How-does-it-happen" aria-hidden="true"></a></h3><h4 id="Stacktrace" class="article-heading"><a href="#Stacktrace" class="headerlink" title="Stacktrace"></a>Stacktrace<a class="article-anchor" href="#Stacktrace" aria-hidden="true"></a></h4><p>When we look at the crash log, it will start from the inflating process: </p>
<p><img src="stacktrace_1.png" alt="stacktrace_1"></p>
<p>and end up calling to <code>getDrawable</code>, which cause the system to allocate a bitmap for pixel data:</p>
<p><img src="stacktrace_2.png" alt="stacktrace_2"></p>
<h4 id="Suspect-Image" class="article-heading"><a href="#Suspect-Image" class="headerlink" title="Suspect Image"></a>Suspect Image<a class="article-anchor" href="#Suspect-Image" aria-hidden="true"></a></h4><p>Let’s take a look at the size again. Because the system will use <code>ARGB_8888</code> to create a bitmap by default, we can divide the number by <code>4</code>:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">3688412 &#x2F; 4 &#x3D; 921603 &#x3D; 960 * 960</span><br></pre></td></tr></table></figure>

<p>The result shows the image size is <code>960</code>. Luckily, there’s only one <code>ImageView</code> inside the XML file, so we quickly identify the image which causes OOM error.</p>
<h4 id="Targeting-image-resource" class="article-heading"><a href="#Targeting-image-resource" class="headerlink" title="Targeting image resource"></a>Targeting image resource<a class="article-anchor" href="#Targeting-image-resource" aria-hidden="true"></a></h4><p>Since the <code>screenDensity</code> of the crashed device is <code>320</code>. We found the image inside <code>drawable-xhdpi</code>:</p>
<p><img src="image.png" alt="image"></p>
<p>It’s a WebP with the size just the same as we expect, now we find the reason for the OOM.</p>
<h3 id="Lesson-learn" class="article-heading"><a href="#Lesson-learn" class="headerlink" title="Lesson learn"></a>Lesson learn<a class="article-anchor" href="#Lesson-learn" aria-hidden="true"></a></h3><p>WebP can be pretty small in size but may be very large in bitmap at Runtime. The bitmap size of a WebP will depend on the size of the image before the transformation. <strong>Don’t create a WebP from a PNG that the size is larger than you need.</strong></p>
<h3 id="What’s-more" class="article-heading"><a href="#What’s-more" class="headerlink" title="What’s more"></a>What’s more<a class="article-anchor" href="#What’s-more" aria-hidden="true"></a></h3><p>If we look at the distribution on all OS version, you can see the crash more likely happens on OS version from 3 to 7:</p>
<p><img src="distribution.png" alt="distribution"></p>
<p>The reason for this is because Google has changed the location to store bitmap. To be short, a bitmap will be stored inside the <code>Dalvik heap</code>, which is limited and mostly is very small; on the contrary, a bitmap will be placed inside the <code>Native heap</code>, which is expandable with a larger limit, sometimes the limit depends on the physical memory size.</p>
<p>With the difference above, you will more easily get OOM on Android 3 to 7, to check more detail about it, please refer to the official document:</p>
<ul>
<li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://developer.android.com/topic/performance/graphics/manage-memory">Managing Bitmap Memory</a></li>
</ul>
<p>If you curious about how this gonna influence the Bitmap Memory, please check:</p>
<ul>
<li><a href="https://ansgarlin.github.io/en/news/2019/09/07/oom_bitmap_resource_analysis/">OOM — Bitmap resource analysis</a></li>
</ul>

  </div>
  
<section id="comments">
  <div id="disqus_thread"></div>
</section>
<script>
  var disqus_shortname = 'ansgarlin';
  var disqus_url = 'https://ansgarlin.github.io/en/news/2019/07/04/oom_webp/index.html';
  var disqus_title = "OOM - WebP";
  var disqus_config = function(){
    this.language = 'en';
  };
  (function(){
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'https://go.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>

</article>

    </div>
  </div>
</div>
    <footer id="footer" class="wrapper">
  <div class="inner">
    <div id="footer-copyright">
      &copy; 2020 Ansgar Lin. Powered by <a href="https://hexo.io/" rel="external nofollow noreferrer" target="_blank">Hexo</a><br>
      Documentation licensed under <a href="http://creativecommons.org/licenses/by/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>.
    </div>
    <div id="footer-links">
      <a href="mailto:AnsgarLin@gmail.com" rel="external nofollow noreferrer" class="footer-link" target="_blank"><i class="fa fa-envelope"></i></a>
      <a href="https://www.linkedin.com/in/AnsgarLin" rel="external nofollow noreferrer" class="footer-link" target="_blank"><i class="fa fa-linkedin-square"></i></a>
      <a href="https://github.com/AnsgarLin" rel="external nofollow noreferrer" class="footer-link" target="_blank"><i class="fa fa-github-square"></i></a>
      <a href="https://AnsgarLin.gitbooks.io/" rel="external nofollow noreferrer" class="footer-link" target="_blank"><i class="fa fa-book"></i></a>
    </div>
  </div>
</footer>

  </div>
  <div id="mobile-nav-dimmer"></div>
  <nav id="mobile-nav">
  <div id="mobile-nav-inner">
    <ul id="mobile-nav-list">
      <a href="/news/" class="mobile-nav-link">Post</a><a href="/android/" class="mobile-nav-link">Android</a><a href="/kotlin/" class="mobile-nav-link">Kotlin</a><a href="/rxjava/" class="mobile-nav-link">RxJava</a>
      <li class="mobile-nav-item">
        <a href="https://github.com/AnsgarLin" class="mobile-nav-link" rel="external" target="_blank">GitHub</a>
      </li>
    </ul>
    
  </div>
  <div id="mobile-lang-select-wrap">
    <span id="mobile-lang-select-label"><i class="fa fa-globe"></i><span>English</span></span>
    <select id="mobile-lang-select" data-canonical="">
      
        <option value="en" selected>English</option>
      
        <option value="zh-tw">正體中文</option>
      
    </select>
  </div>
</nav>
  <!-- Scripts -->
<!-- Cookie -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/js-cookie/2.2.0/js.cookie.min.js"></script>
<!-- build:js build/js/main.js -->

<script src="/js/lang_select.js"></script>
 
<script src="/js/toc.js"></script>
 
<script src="/js/mobile_nav.js"></script>

<!-- endbuild -->

<!-- Algolia -->

<script src="//cdn.jsdelivr.net/autocomplete.js/0/autocomplete.min.js"></script>
<script src="//cdn.jsdelivr.net/algoliasearch/3/algoliasearch.min.js"></script>
<script type="text/javascript">
    document.getElementById('search-input-wrap').classList.add('on');
    var client = algoliasearch('769KWCTEZG', 'e6a393ae2870a9ce5f88a275f04156a3');
    var index = client.initIndex('ansgar');
    autocomplete('#search-input', { 
        hint: false
    }, [
        {
          source: autocomplete.sources.hits(index, { hitsPerPage: 5 }),
          templates: {
            suggestion: function(suggestion) {
              return '<div class="algolia-docsearch-suggestion algolia-docsearch-suggestion__main algolia-docsearch-suggestion__secondary" style="white-space: normal;"><div class="algolia-docsearch-suggestion--category-header">' + 
                  suggestion._highlightResult.title.value + //<span class="algolia-docsearch-suggestion--highlight">R</span>outer
              '</div>' + 
              '<div class="algolia-docsearch-suggestion--wrapper"><div class="algolia-docsearch-suggestion--subcategory-column"><span class="algolia-docsearch-suggestion--subcategory-column-text">' +
                  suggestion._highlightResult.title.value +//<span class="algolia-docsearch-suggestion--highlight">R</span>outer</span
              '</div>' + 
              '<div class="algolia-docsearch-suggestion--content"><div class="algolia-docsearch-suggestion--subcategory-inline">' + 
                  suggestion._highlightResult.title.value +//<span class="algolia-docsearch-suggestion--highlight">R</span>outer
              '</div>' + 
              '<div class="algolia-docsearch-suggestion--title">' + 
                  suggestion._highlightResult.title.value +//<span class="algolia-docsearch-suggestion--highlight">R</span>outer
              '</div>' + 
              '<div class="algolia-docsearch-suggestion--text">' + 
                  suggestion._highlightResult.text.value +//<span class="algolia-docsearch-suggestion--highlight">R</span>outer
              '</div>' + 
//                  The <span class="algolia-docsearch-suggestion--highlight">r</span>outer saves all paths used in the site…</div>
              '</div></div></div>'
                
//              return '<a href="/material_design/">' + suggestion._highlightResult.name.value + '</a>';
//              return suggestion._highlightResult.name.value;
            }
          }
        }
      ]).on('autocomplete:selected', function(event, suggestion, dataset) {
        window.location = '/' + suggestion.path;
        return dataset.source;
//    console.log(suggestion, dataset);
    });
</script>

</body>
</html>